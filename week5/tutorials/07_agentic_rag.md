# ğŸ“˜ Agentic RAG - Agenté©±åŠ¨çš„æ™ºèƒ½æ£€ç´¢

> **å­¦ä¹ ç›®æ ‡**ï¼šæŒæ¡Agentic RAGæŠ€æœ¯ï¼Œæ„å»ºèƒ½è‡ªä¸»å†³ç­–ã€å¤šæ­¥æ¨ç†çš„æ™ºèƒ½RAGç³»ç»Ÿ

---

## ğŸ¯ ä»RAGåˆ°Agentic RAG

### ä¼ ç»ŸRAG vs Agentic RAG

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    ä¼ ç»ŸRAGï¼ˆè¢«åŠ¨ç®¡é“ï¼‰                           â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                  â”‚
â”‚   é—®é¢˜ â†’ æ£€ç´¢ â†’ ç”Ÿæˆ â†’ å›ç­”                                      â”‚
â”‚   (å›ºå®šæµç¨‹ï¼Œæ— æ³•æ ¹æ®æƒ…å†µè°ƒæ•´)                                    â”‚
â”‚                                                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                   Agentic RAGï¼ˆä¸»åŠ¨å†³ç­–ï¼‰                        â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                  â”‚
â”‚   é—®é¢˜ â†’ Agentæ€è€ƒï¼š                                             â”‚
â”‚          â”œâ”€â”€ éœ€è¦æ£€ç´¢å—ï¼Ÿæ£€ç´¢å“ªä¸ªçŸ¥è¯†åº“ï¼Ÿ                        â”‚
â”‚          â”œâ”€â”€ æ£€ç´¢ç»“æœå¤Ÿç”¨å—ï¼Ÿéœ€è¦è¡¥å……æœç´¢å—ï¼Ÿ                    â”‚
â”‚          â”œâ”€â”€ éœ€è¦å¤šæ­¥æ¨ç†å—ï¼Ÿéœ€è¦è°ƒç”¨å…¶ä»–å·¥å…·å—ï¼Ÿ                â”‚
â”‚          â””â”€â”€ å›ç­”è´¨é‡å¦‚ä½•ï¼Ÿéœ€è¦é‡æ–°ç”Ÿæˆå—ï¼Ÿ                      â”‚
â”‚                                                                  â”‚
â”‚   Agentè‡ªä¸»è§„åˆ’ â†’ æ‰§è¡Œ â†’ éªŒè¯ â†’ è¿­ä»£ â†’ æœ€ç»ˆå›ç­”                  â”‚
â”‚                                                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### æ ¸å¿ƒèƒ½åŠ›å¯¹æ¯”

| èƒ½åŠ› | ä¼ ç»ŸRAG | Agentic RAG |
|-----|--------|-------------|
| æ£€ç´¢å†³ç­– | æ€»æ˜¯æ£€ç´¢ | æŒ‰éœ€æ£€ç´¢ |
| çŸ¥è¯†åº“é€‰æ‹© | å›ºå®šå•ä¸€ | åŠ¨æ€é€‰æ‹©å¤šä¸ª |
| æŸ¥è¯¢ä¼˜åŒ– | æ—  | è‡ªåŠ¨æ”¹å†™/æ‰©å±• |
| ç»“æœéªŒè¯ | æ—  | è‡ªåŠ¨è¯„ä¼° |
| å¤šæ­¥æ¨ç† | ä¸æ”¯æŒ | åŸç”Ÿæ”¯æŒ |
| å·¥å…·è°ƒç”¨ | ä¸æ”¯æŒ | çµæ´»ç»„åˆ |
| å¤±è´¥æ¢å¤ | æ—  | è‡ªåŠ¨é‡è¯•/æ¢ç­–ç•¥ |

---

## ğŸ“š Agentic RAG æ¶æ„

### æ ¸å¿ƒç»„ä»¶

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                     Agentic RAG System                           â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚                    ğŸ§  Agent Core (LLM)                      â”‚ â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚ â”‚
â”‚  â”‚  â”‚   è§„åˆ’   â”‚  â”‚   æ¨ç†   â”‚  â”‚   åæ€   â”‚  â”‚   å†³ç­–   â”‚   â”‚ â”‚
â”‚  â”‚  â”‚ Planning â”‚  â”‚ Reasoningâ”‚  â”‚Reflectionâ”‚  â”‚ Decision â”‚   â”‚ â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                              â”‚                                   â”‚
â”‚                              â–¼                                   â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚                    ğŸ”§ Tool Layer                            â”‚ â”‚
â”‚  â”‚                                                             â”‚ â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”          â”‚ â”‚
â”‚  â”‚  â”‚ å‘é‡æ£€ç´¢     â”‚ â”‚ å›¾è°±æŸ¥è¯¢     â”‚ â”‚ ç½‘ç»œæœç´¢     â”‚          â”‚ â”‚
â”‚  â”‚  â”‚ vector_searchâ”‚ â”‚ graph_query â”‚ â”‚ web_search  â”‚          â”‚ â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜          â”‚ â”‚
â”‚  â”‚                                                             â”‚ â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”          â”‚ â”‚
â”‚  â”‚  â”‚ æ–‡æ¡£æ‘˜è¦     â”‚ â”‚ ä»£ç æ‰§è¡Œ     â”‚ â”‚ æ•°æ®åº“æŸ¥è¯¢   â”‚          â”‚ â”‚
â”‚  â”‚  â”‚ summarize   â”‚ â”‚ execute_codeâ”‚ â”‚ sql_query   â”‚          â”‚ â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜          â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                              â”‚                                   â”‚
â”‚                              â–¼                                   â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚                    ğŸ“š Knowledge Layer                       â”‚ â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”          â”‚ â”‚
â”‚  â”‚  â”‚ æŠ€æœ¯æ–‡æ¡£ â”‚ â”‚ äº§å“æ‰‹å†Œâ”‚ â”‚ çŸ¥è¯†å›¾è°±â”‚ â”‚ å®æ—¶ç½‘ç»œâ”‚          â”‚ â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜          â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ’» Agentic RAG å®ç°

### 1. å®šä¹‰RAGå·¥å…·é›†

```python
from openai import OpenAI
from typing import Callable, Any
import json

# RAGå·¥å…·å®šä¹‰
RAG_TOOLS = [
    {
        "type": "function",
        "function": {
            "name": "vector_search",
            "description": "åœ¨å‘é‡çŸ¥è¯†åº“ä¸­æœç´¢ç›¸å…³æ–‡æ¡£ã€‚é€‚ç”¨äºè¯­ä¹‰ç›¸ä¼¼æ€§æœç´¢ã€‚",
            "parameters": {
                "type": "object",
                "properties": {
                    "query": {
                        "type": "string",
                        "description": "æœç´¢æŸ¥è¯¢"
                    },
                    "collection": {
                        "type": "string",
                        "enum": ["tech_docs", "product_manual", "faq"],
                        "description": "è¦æœç´¢çš„çŸ¥è¯†åº“"
                    },
                    "top_k": {
                        "type": "integer",
                        "default": 5,
                        "description": "è¿”å›ç»“æœæ•°é‡"
                    }
                },
                "required": ["query", "collection"]
            }
        }
    },
    {
        "type": "function",
        "function": {
            "name": "graph_query",
            "description": "åœ¨çŸ¥è¯†å›¾è°±ä¸­æŸ¥è¯¢å®ä½“å…³ç³»ã€‚é€‚ç”¨äºå¤šè·³æ¨ç†å’Œå…³ç³»æŸ¥è¯¢ã€‚",
            "parameters": {
                "type": "object",
                "properties": {
                    "entity": {
                        "type": "string",
                        "description": "èµ·å§‹å®ä½“åç§°"
                    },
                    "relation": {
                        "type": "string",
                        "description": "è¦æŸ¥è¯¢çš„å…³ç³»ç±»å‹ï¼ˆå¯é€‰ï¼‰"
                    },
                    "depth": {
                        "type": "integer",
                        "default": 2,
                        "description": "æŸ¥è¯¢æ·±åº¦"
                    }
                },
                "required": ["entity"]
            }
        }
    },
    {
        "type": "function",
        "function": {
            "name": "web_search",
            "description": "æœç´¢äº’è”ç½‘è·å–æœ€æ–°ä¿¡æ¯ã€‚é€‚ç”¨äºçŸ¥è¯†åº“ä¸­æ²¡æœ‰çš„å®æ—¶ä¿¡æ¯ã€‚",
            "parameters": {
                "type": "object",
                "properties": {
                    "query": {
                        "type": "string",
                        "description": "æœç´¢æŸ¥è¯¢"
                    }
                },
                "required": ["query"]
            }
        }
    },
    {
        "type": "function",
        "function": {
            "name": "rewrite_query",
            "description": "é‡å†™æŸ¥è¯¢ä»¥æé«˜æ£€ç´¢æ•ˆæœã€‚å½“åˆå§‹æ£€ç´¢ç»“æœä¸ç†æƒ³æ—¶ä½¿ç”¨ã€‚",
            "parameters": {
                "type": "object",
                "properties": {
                    "original_query": {
                        "type": "string",
                        "description": "åŸå§‹æŸ¥è¯¢"
                    },
                    "strategy": {
                        "type": "string",
                        "enum": ["expand", "simplify", "decompose"],
                        "description": "é‡å†™ç­–ç•¥ï¼šexpandæ‰©å±•ã€simplifyç®€åŒ–ã€decomposeåˆ†è§£"
                    }
                },
                "required": ["original_query", "strategy"]
            }
        }
    },
    {
        "type": "function",
        "function": {
            "name": "evaluate_relevance",
            "description": "è¯„ä¼°æ£€ç´¢ç»“æœä¸é—®é¢˜çš„ç›¸å…³æ€§ï¼Œå†³å®šæ˜¯å¦éœ€è¦æ›´å¤šæ£€ç´¢ã€‚",
            "parameters": {
                "type": "object",
                "properties": {
                    "question": {
                        "type": "string",
                        "description": "ç”¨æˆ·é—®é¢˜"
                    },
                    "retrieved_content": {
                        "type": "string",
                        "description": "å·²æ£€ç´¢çš„å†…å®¹"
                    }
                },
                "required": ["question", "retrieved_content"]
            }
        }
    }
]
```

### 2. å·¥å…·å®ç°

```python
class RAGToolExecutor:
    """RAGå·¥å…·æ‰§è¡Œå™¨"""
    
    def __init__(self, vector_stores: dict, knowledge_graph, web_search_client):
        self.vector_stores = vector_stores
        self.kg = knowledge_graph
        self.web_client = web_search_client
    
    async def execute(self, tool_name: str, arguments: dict) -> str:
        """æ‰§è¡Œå·¥å…·è°ƒç”¨"""
        if tool_name == "vector_search":
            return await self._vector_search(**arguments)
        elif tool_name == "graph_query":
            return await self._graph_query(**arguments)
        elif tool_name == "web_search":
            return await self._web_search(**arguments)
        elif tool_name == "rewrite_query":
            return await self._rewrite_query(**arguments)
        elif tool_name == "evaluate_relevance":
            return await self._evaluate_relevance(**arguments)
        else:
            return f"æœªçŸ¥å·¥å…·: {tool_name}"
    
    async def _vector_search(
        self, 
        query: str, 
        collection: str, 
        top_k: int = 5
    ) -> str:
        """å‘é‡æ£€ç´¢"""
        if collection not in self.vector_stores:
            return f"çŸ¥è¯†åº“ {collection} ä¸å­˜åœ¨"
        
        results = self.vector_stores[collection].query(
            query_texts=[query],
            n_results=top_k
        )
        
        docs = results["documents"][0]
        if not docs:
            return "æœªæ‰¾åˆ°ç›¸å…³æ–‡æ¡£"
        
        return "\n\n---\n\n".join([
            f"[æ–‡æ¡£{i+1}]\n{doc}" 
            for i, doc in enumerate(docs)
        ])
    
    async def _graph_query(
        self, 
        entity: str, 
        relation: str = None, 
        depth: int = 2
    ) -> str:
        """çŸ¥è¯†å›¾è°±æŸ¥è¯¢"""
        neighbors = self.kg.query_neighbors(entity, depth)
        
        if not neighbors:
            return f"æœªæ‰¾åˆ°å®ä½“ {entity} çš„ç›¸å…³ä¿¡æ¯"
        
        result = [f"å®ä½“: {entity}"]
        for n in neighbors[:10]:
            result.append(f"  â†’ {n['name']} ({n['type']})")
        
        return "\n".join(result)
    
    async def _web_search(self, query: str) -> str:
        """ç½‘ç»œæœç´¢"""
        results = await self.web_client.search(query, max_results=3)
        return "\n\n".join([
            f"[{r['title']}]\n{r['content']}" 
            for r in results
        ])
    
    async def _rewrite_query(
        self, 
        original_query: str, 
        strategy: str
    ) -> str:
        """æŸ¥è¯¢é‡å†™"""
        strategies = {
            "expand": f"å°†ä»¥ä¸‹æŸ¥è¯¢æ‰©å±•ä¸ºæ›´å…¨é¢çš„æœç´¢è¯ï¼š{original_query}",
            "simplify": f"å°†ä»¥ä¸‹æŸ¥è¯¢ç®€åŒ–ä¸ºæ ¸å¿ƒå…³é”®è¯ï¼š{original_query}",
            "decompose": f"å°†ä»¥ä¸‹å¤æ‚æŸ¥è¯¢åˆ†è§£ä¸ºå¤šä¸ªç®€å•å­æŸ¥è¯¢ï¼š{original_query}"
        }
        
        # è¿™é‡Œå¯ä»¥è°ƒç”¨LLMè¿›è¡Œé‡å†™
        return f"é‡å†™åçš„æŸ¥è¯¢: {original_query} ({strategy}ç­–ç•¥)"
    
    async def _evaluate_relevance(
        self, 
        question: str, 
        retrieved_content: str
    ) -> str:
        """è¯„ä¼°ç›¸å…³æ€§"""
        # ç®€åŒ–ç‰ˆæœ¬ï¼Œå®é™…å¯ä»¥ç”¨LLMè¯„ä¼°
        if len(retrieved_content) < 100:
            return "ç›¸å…³æ€§: ä½ - å»ºè®®è¡¥å……æ£€ç´¢"
        return "ç›¸å…³æ€§: é«˜ - å¯ä»¥ç”Ÿæˆå›ç­”"
```

### 3. Agentic RAG Agent

```python
class AgenticRAGAgent:
    """Agentic RAG Agent - è‡ªä¸»å†³ç­–çš„æ™ºèƒ½æ£€ç´¢ä»£ç†"""
    
    SYSTEM_PROMPT = """ä½ æ˜¯ä¸€ä¸ªæ™ºèƒ½æ£€ç´¢ä»£ç†ï¼Œè´Ÿè´£ä¸ºç”¨æˆ·é—®é¢˜æ‰¾åˆ°æœ€ä½³ç­”æ¡ˆã€‚

ä½ æ‹¥æœ‰ä»¥ä¸‹å·¥å…·:
1. vector_search: åœ¨å‘é‡çŸ¥è¯†åº“ä¸­è¯­ä¹‰æœç´¢
2. graph_query: åœ¨çŸ¥è¯†å›¾è°±ä¸­æŸ¥è¯¢å®ä½“å…³ç³»
3. web_search: æœç´¢äº’è”ç½‘è·å–æœ€æ–°ä¿¡æ¯
4. rewrite_query: é‡å†™æŸ¥è¯¢æé«˜æ£€ç´¢æ•ˆæœ
5. evaluate_relevance: è¯„ä¼°æ£€ç´¢ç»“æœçš„ç›¸å…³æ€§

å·¥ä½œæµç¨‹:
1. åˆ†æç”¨æˆ·é—®é¢˜ï¼Œå†³å®šä½¿ç”¨å“ªäº›å·¥å…·
2. æ‰§è¡Œæ£€ç´¢ï¼Œè¯„ä¼°ç»“æœè´¨é‡
3. å¦‚æœç»“æœä¸å¤Ÿå¥½ï¼Œå°è¯•ä¸åŒç­–ç•¥ï¼ˆé‡å†™æŸ¥è¯¢ã€æ¢çŸ¥è¯†åº“ã€ç½‘ç»œæœç´¢ï¼‰
4. æ”¶é›†è¶³å¤Ÿä¿¡æ¯åï¼Œç”Ÿæˆæœ€ç»ˆç­”æ¡ˆ

é‡è¦åŸåˆ™:
- å…ˆå°è¯•å†…éƒ¨çŸ¥è¯†åº“ï¼Œä¸å¤Ÿå†æœç´¢ç½‘ç»œ
- å¤æ‚é—®é¢˜å¯èƒ½éœ€è¦å¤šæ¬¡æ£€ç´¢
- æ¶‰åŠå®ä½“å…³ç³»çš„é—®é¢˜ï¼Œä¼˜å…ˆä½¿ç”¨graph_query
- éœ€è¦æœ€æ–°ä¿¡æ¯æ—¶ï¼Œä½¿ç”¨web_search
- å§‹ç»ˆéªŒè¯æ£€ç´¢ç»“æœçš„ç›¸å…³æ€§
"""
    
    def __init__(
        self, 
        client: OpenAI,
        tool_executor: RAGToolExecutor,
        max_iterations: int = 5
    ):
        self.client = client
        self.tool_executor = tool_executor
        self.max_iterations = max_iterations
    
    async def query(self, question: str) -> dict:
        """æ‰§è¡ŒAgentic RAGæŸ¥è¯¢"""
        
        messages = [
            {"role": "system", "content": self.SYSTEM_PROMPT},
            {"role": "user", "content": question}
        ]
        
        tool_calls_log = []
        iteration = 0
        
        while iteration < self.max_iterations:
            iteration += 1
            
            # Agentæ€è€ƒå¹¶å†³ç­–
            response = await self.client.chat.completions.create(
                model="deepseek-chat",
                messages=messages,
                tools=RAG_TOOLS,
                tool_choice="auto",
                temperature=0
            )
            
            message = response.choices[0].message
            
            # æ£€æŸ¥æ˜¯å¦æœ‰å·¥å…·è°ƒç”¨
            if message.tool_calls:
                # æ‰§è¡Œæ‰€æœ‰å·¥å…·è°ƒç”¨
                messages.append(message)
                
                for tool_call in message.tool_calls:
                    func_name = tool_call.function.name
                    arguments = json.loads(tool_call.function.arguments)
                    
                    # æ‰§è¡Œå·¥å…·
                    result = await self.tool_executor.execute(func_name, arguments)
                    
                    tool_calls_log.append({
                        "tool": func_name,
                        "arguments": arguments,
                        "result_preview": result[:200] + "..." if len(result) > 200 else result
                    })
                    
                    # æ·»åŠ å·¥å…·ç»“æœåˆ°æ¶ˆæ¯
                    messages.append({
                        "role": "tool",
                        "tool_call_id": tool_call.id,
                        "content": result
                    })
            
            else:
                # æ²¡æœ‰å·¥å…·è°ƒç”¨ï¼ŒAgentç»™å‡ºæœ€ç»ˆç­”æ¡ˆ
                return {
                    "answer": message.content,
                    "iterations": iteration,
                    "tool_calls": tool_calls_log
                }
        
        # è¾¾åˆ°æœ€å¤§è¿­ä»£æ¬¡æ•°
        return {
            "answer": "æŠ±æ­‰ï¼Œç»è¿‡å¤šæ¬¡å°è¯•ä»æ— æ³•æ‰¾åˆ°æ»¡æ„çš„ç­”æ¡ˆã€‚",
            "iterations": iteration,
            "tool_calls": tool_calls_log
        }
```

---

## ğŸš€ ä½¿ç”¨ç¤ºä¾‹

```python
import asyncio
import chromadb

async def main():
    # åˆå§‹åŒ–
    client = OpenAI(base_url="https://api.deepseek.com/v1", api_key="your-key")
    
    # åˆ›å»ºå‘é‡å­˜å‚¨
    chroma = chromadb.Client()
    tech_docs = chroma.create_collection("tech_docs")
    product_manual = chroma.create_collection("product_manual")
    
    # æ·»åŠ ç¤ºä¾‹æ•°æ®
    tech_docs.add(
        documents=[
            "FastAPIæ˜¯ä¸€ä¸ªç°ä»£çš„Python Webæ¡†æ¶ï¼Œæ”¯æŒå¼‚æ­¥ç¼–ç¨‹...",
            "Pydanticç”¨äºæ•°æ®éªŒè¯ï¼Œæ˜¯FastAPIçš„æ ¸å¿ƒä¾èµ–...",
        ],
        ids=["doc1", "doc2"]
    )
    
    # åˆå§‹åŒ–å·¥å…·æ‰§è¡Œå™¨
    tool_executor = RAGToolExecutor(
        vector_stores={"tech_docs": tech_docs, "product_manual": product_manual},
        knowledge_graph=None,  # ç®€åŒ–ç¤ºä¾‹
        web_search_client=None
    )
    
    # åˆ›å»ºAgentic RAG Agent
    agent = AgenticRAGAgent(client, tool_executor)
    
    # æµ‹è¯•æŸ¥è¯¢
    result = await agent.query("FastAPIå’ŒPydanticæ˜¯ä»€ä¹ˆå…³ç³»ï¼Ÿ")
    
    print("=== Agentic RAG ç»“æœ ===")
    print(f"å›ç­”: {result['answer']}")
    print(f"è¿­ä»£æ¬¡æ•°: {result['iterations']}")
    print(f"å·¥å…·è°ƒç”¨è®°å½•:")
    for call in result['tool_calls']:
        print(f"  - {call['tool']}: {call['arguments']}")

asyncio.run(main())
```

---

## ğŸ“Š Agentic RAG å†³ç­–æµç¨‹

```
ç”¨æˆ·é—®é¢˜: "FastAPI 2.0å’Œ1.0çš„ä¸»è¦åŒºåˆ«æ˜¯ä»€ä¹ˆï¼Ÿæœ€æ–°ç‰ˆæœ¬æœ‰ä»€ä¹ˆæ–°ç‰¹æ€§ï¼Ÿ"

Agentæ€è€ƒè¿‡ç¨‹:
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Thought 1: è¿™ä¸ªé—®é¢˜æ¶‰åŠç‰ˆæœ¬æ¯”è¾ƒå’Œæœ€æ–°ä¿¡æ¯                         â”‚
â”‚           â†’ å…ˆåœ¨tech_docsä¸­æœç´¢FastAPIç‰ˆæœ¬ä¿¡æ¯                   â”‚
â”‚                                                                  â”‚
â”‚ Action 1: vector_search(query="FastAPIç‰ˆæœ¬åŒºåˆ«", collection="tech_docs") â”‚
â”‚                                                                  â”‚
â”‚ Observation 1: æ‰¾åˆ°ä¸€äº›FastAPIåŸºç¡€æ–‡æ¡£ï¼Œä½†æ²¡æœ‰ç‰ˆæœ¬æ¯”è¾ƒä¿¡æ¯        â”‚
â”‚                                                                  â”‚
â”‚ Thought 2: å†…éƒ¨çŸ¥è¯†åº“ä¿¡æ¯ä¸å¤Ÿæ–°ï¼Œéœ€è¦æœç´¢ç½‘ç»œ                     â”‚
â”‚           â†’ ä½¿ç”¨web_searchè·å–æœ€æ–°ç‰ˆæœ¬ä¿¡æ¯                       â”‚
â”‚                                                                  â”‚
â”‚ Action 2: web_search(query="FastAPI 2.0 æ–°ç‰¹æ€§ æ›´æ–°")            â”‚
â”‚                                                                  â”‚
â”‚ Observation 2: è·å–åˆ°æœ€æ–°ç‰ˆæœ¬æ›´æ–°æ—¥å¿—                            â”‚
â”‚                                                                  â”‚
â”‚ Thought 3: evaluate_relevanceè¯„ä¼°ä¿¡æ¯æ˜¯å¦è¶³å¤Ÿ                    â”‚
â”‚                                                                  â”‚
â”‚ Action 3: evaluate_relevance(question=..., retrieved_content=...) â”‚
â”‚                                                                  â”‚
â”‚ Observation 3: ç›¸å…³æ€§é«˜ï¼Œå¯ä»¥ç”Ÿæˆå›ç­”                            â”‚
â”‚                                                                  â”‚
â”‚ Final Answer: ç»¼åˆåˆ†æåç»™å‡ºå®Œæ•´å›ç­”                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ”— ä¸Week6 Agentçš„è¿‡æ¸¡

> [!IMPORTANT]
> **Agentic RAG æ˜¯ RAG åˆ° Agent çš„å…³é”®æ¡¥æ¢**
> 
> ä½ åœ¨æœ¬æ•™ç¨‹ä¸­å­¦ä¹ çš„æ ¸å¿ƒæ¦‚å¿µï¼š
> - **å·¥å…·è°ƒç”¨** (Tool Use) â†’ Week6 å°†æ·±å…¥è®²è§£
> - **è‡ªä¸»å†³ç­–** (Autonomous Decision) â†’ Agentçš„æ ¸å¿ƒèƒ½åŠ›
> - **æ€è€ƒ-è¡ŒåŠ¨-è§‚å¯Ÿå¾ªç¯** â†’ ReActæ¡†æ¶çš„åŸºç¡€
> 
> Week6å°†æŠŠè¿™äº›æ¦‚å¿µæ‰©å±•åˆ°æ›´é€šç”¨çš„Agentç³»ç»Ÿï¼

### æ¦‚å¿µæ˜ å°„

| Agentic RAGæ¦‚å¿µ | Week6 Agentæ¦‚å¿µ |
|----------------|----------------|
| æ£€ç´¢å·¥å…· | Agentå·¥å…·ç®±çš„ä¸€éƒ¨åˆ† |
| è‡ªä¸»å†³ç­–æ£€ç´¢ç­–ç•¥ | Agentçš„è§„åˆ’èƒ½åŠ› |
| æ£€ç´¢ç»“æœè¯„ä¼° | Agentçš„åæ€èƒ½åŠ› |
| å¤šæ­¥æ¨ç† | Agentçš„æ¨ç†é“¾ |

---

## ğŸ“Š å­¦ä¹ æ£€æŸ¥æ¸…å•

- [ ] ç†è§£Agentic RAGä¸ä¼ ç»ŸRAGçš„åŒºåˆ«
- [ ] èƒ½å¤Ÿå®šä¹‰RAGç›¸å…³çš„å·¥å…·Schema
- [ ] æŒæ¡å·¥å…·æ‰§è¡Œå™¨çš„å®ç°
- [ ] ç†è§£Agentçš„è‡ªä¸»å†³ç­–æµç¨‹
- [ ] çŸ¥é“å¦‚ä½•å¤„ç†å¤šæ­¥æ£€ç´¢åœºæ™¯

---

## ğŸ¯ ä¸‹ä¸€æ­¥

æ­å–œå®ŒæˆWeek5 RAGè¿›é˜¶å…¨éƒ¨å†…å®¹ï¼

ç»§ç»­å‰å¾€ï¼š
ğŸ‘‰ [Week6: æ™ºèƒ½ä½“å…¥é—¨](../week6/README.md)

ä½ å°†å­¦ä¹ ï¼š
- ReActæ¡†æ¶è¯¦è§£
- æ›´ä¸°å¯Œçš„å·¥å…·ä½¿ç”¨
- å¤šAgentåä½œ
- å®Œæ•´Agentç³»ç»Ÿæ„å»º
