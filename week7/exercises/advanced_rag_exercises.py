# ğŸ’» é«˜çº§RAGç»ƒä¹ 

"""
Week 7-8 è¿›é˜¶ç»ƒä¹ 
æ¶µç›–ï¼šä¼ä¸šçº§RAGã€å¤šæ¨¡æ€å¤„ç†
"""

from typing import List, Optional
from pydantic import BaseModel


# ============================================
# ç»ƒä¹ 1ï¼šè‡ªå®šä¹‰æ–‡æ¡£åŠ è½½å™¨
# ============================================

class DocumentChunk(BaseModel):
    """æ–‡æ¡£å—æ¨¡å‹"""
    id: str
    content: str
    metadata: dict
    embedding: Optional[List[float]] = None


def exercise_1_custom_loader():
    """
    ç»ƒä¹ 1ï¼šå®ç°è‡ªå®šä¹‰PDFåŠ è½½å™¨
    
    è¦æ±‚ï¼š
    1. ä½¿ç”¨pdfplumberè¯»å–PDF
    2. æŒ‰æ®µè½åˆ†å—ï¼ˆæ¯å—ä¸è¶…è¿‡500å­—ç¬¦ï¼‰
    3. å¤„ç†é‡å ï¼ˆoverlap=100å­—ç¬¦ï¼‰
    4. è¿”å›DocumentChunkåˆ—è¡¨
    
    æµ‹è¯•æ–‡ä»¶ï¼šéšä¾¿æ‰¾ä¸€ä¸ªPDFæ–‡ä»¶æµ‹è¯•
    """
    # TODO: å®ç°ä½ çš„ä»£ç 
    pass


# ============================================
# ç»ƒä¹ 2ï¼šæ··åˆæ£€ç´¢å®ç°
# ============================================

def exercise_2_hybrid_search(
    query: str,
    documents: List[DocumentChunk],
    alpha: float = 0.5  # è¯­ä¹‰æ£€ç´¢æƒé‡
) -> List[DocumentChunk]:
    """
    ç»ƒä¹ 2ï¼šå®ç°æ··åˆæ£€ç´¢
    
    è¦æ±‚ï¼š
    1. å®ç°è¯­ä¹‰æ£€ç´¢ï¼ˆä½¿ç”¨embeddingç›¸ä¼¼åº¦ï¼‰
    2. å®ç°å…³é”®è¯æ£€ç´¢ï¼ˆBM25æˆ–ç®€å•TF-IDFï¼‰
    3. èåˆä¸¤ç§ç»“æœï¼ˆä½¿ç”¨alphaæƒé‡ï¼‰
    4. è¿”å›top-5ç»“æœ
    
    æç¤ºï¼š
    - å¯ä»¥ç”¨sklearnçš„TfidfVectorizer
    - è¯­ä¹‰ç›¸ä¼¼åº¦ç”¨cosine similarity
    """
    # TODO: å®ç°ä½ çš„ä»£ç 
    pass


# ============================================
# ç»ƒä¹ 3ï¼šé‡æ’åºå®ç°
# ============================================

def exercise_3_reranking(
    query: str,
    candidates: List[DocumentChunk],
    top_k: int = 3
) -> List[DocumentChunk]:
    """
    ç»ƒä¹ 3ï¼šä½¿ç”¨LLMè¿›è¡Œé‡æ’åº
    
    è¦æ±‚ï¼š
    1. å¯¹å€™é€‰æ–‡æ¡£è¿›è¡Œç›¸å…³æ€§æ‰“åˆ†
    2. ä½¿ç”¨LLMè¯„ä¼°æ¯ä¸ªæ–‡æ¡£ä¸queryçš„ç›¸å…³åº¦ï¼ˆ1-10åˆ†ï¼‰
    3. æŒ‰å¾—åˆ†é‡æ–°æ’åº
    4. è¿”å›top_kç»“æœ
    
    æç¤ºï¼š
    - æ„å»ºè¯„åˆ†prompt
    - æ‰¹é‡è¯„ä¼°ä»¥èŠ‚çœAPIè°ƒç”¨
    """
    # TODO: å®ç°ä½ çš„ä»£ç 
    pass


# ============================================
# ç»ƒä¹ 4ï¼šä¸Šä¸‹æ–‡å‹ç¼©
# ============================================

def exercise_4_context_compression(
    query: str,
    documents: List[str],
    max_tokens: int = 2000
) -> str:
    """
    ç»ƒä¹ 4ï¼šå®ç°ä¸Šä¸‹æ–‡å‹ç¼©
    
    è¦æ±‚ï¼š
    1. ä»æ¯ä¸ªæ–‡æ¡£ä¸­æå–ä¸queryç›¸å…³çš„å¥å­
    2. åˆå¹¶æ‰€æœ‰ç›¸å…³å†…å®¹
    3. ç¡®ä¿æ€»é•¿åº¦ä¸è¶…è¿‡max_tokens
    4. è¿”å›å‹ç¼©åçš„ä¸Šä¸‹æ–‡
    
    æç¤ºï¼š
    - å¯ä»¥ç”¨LLMæå–å…³é”®å¥
    - ä¹Ÿå¯ä»¥ç”¨å¥å­ç›¸ä¼¼åº¦ç­›é€‰
    """
    # TODO: å®ç°ä½ çš„ä»£ç 
    pass


# ============================================
# ç»ƒä¹ 5ï¼šå¤šæ¨¡æ€é—®ç­”
# ============================================

async def exercise_5_multimodal_qa(
    question: str,
    image_path: Optional[str] = None
) -> str:
    """
    ç»ƒä¹ 5ï¼šå®ç°å¤šæ¨¡æ€é—®ç­”
    
    è¦æ±‚ï¼š
    1. å¦‚æœæœ‰å›¾ç‰‡ï¼Œå…ˆç”¨GPT-4Våˆ†æå›¾ç‰‡å†…å®¹
    2. ç»“åˆå›¾ç‰‡åˆ†æç»“æœå’Œé—®é¢˜ç”Ÿæˆå›ç­”
    3. å¤„ç†æ— å›¾ç‰‡çš„æƒ…å†µ
    
    æç¤ºï¼š
    - ä½¿ç”¨base64ç¼–ç å›¾ç‰‡
    - æ„å»ºå¤šæ¨¡æ€prompt
    """
    # TODO: å®ç°ä½ çš„ä»£ç 
    pass


# ============================================
# è¿è¡Œæµ‹è¯•
# ============================================

if __name__ == "__main__":
    print("Week 7-8 é«˜çº§RAGç»ƒä¹ ")
    print("=" * 50)
    
    # æµ‹è¯•ç»ƒä¹ 1
    print("\nç»ƒä¹ 1ï¼šè‡ªå®šä¹‰æ–‡æ¡£åŠ è½½å™¨")
    # result = exercise_1_custom_loader()
    # print(f"åŠ è½½äº† {len(result)} ä¸ªæ–‡æ¡£å—")
    
    # æµ‹è¯•ç»ƒä¹ 2
    print("\nç»ƒä¹ 2ï¼šæ··åˆæ£€ç´¢")
    # results = exercise_2_hybrid_search("ä»€ä¹ˆæ˜¯RAG", documents)
    # print(f"æ£€ç´¢åˆ° {len(results)} ä¸ªç»“æœ")
    
    # æµ‹è¯•ç»ƒä¹ 3
    print("\nç»ƒä¹ 3ï¼šé‡æ’åº")
    # reranked = exercise_3_reranking("å¦‚ä½•å¾®è°ƒæ¨¡å‹", candidates)
    
    # æµ‹è¯•ç»ƒä¹ 4
    print("\nç»ƒä¹ 4ï¼šä¸Šä¸‹æ–‡å‹ç¼©")
    # compressed = exercise_4_context_compression(query, docs)
    
    # æµ‹è¯•ç»ƒä¹ 5
    print("\nç»ƒä¹ 5ï¼šå¤šæ¨¡æ€é—®ç­”")
    # import asyncio
    # answer = asyncio.run(exercise_5_multimodal_qa("æè¿°è¿™å¼ å›¾ç‰‡", "test.jpg"))
    
    print("\nè¯·å®Œæˆä¸Šè¿°ç»ƒä¹ ï¼Œè¿è¡Œæµ‹è¯•éªŒè¯ä½ çš„å®ç°ï¼")
